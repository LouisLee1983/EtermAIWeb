# EtermAIWeb 宝塔面板部署指南

## 概述

本指南将详细说明如何在安装了宝塔Linux面板的云服务器上部署EtermAIWeb项目，包括手工初始部署和GitHub Actions自动化流程。

## 环境要求

- 云服务器：47.111.119.238
- 操作系统：Linux (CentOS/Ubuntu)
- 宝塔Linux面板已安装
- PostgreSQL已通过宝塔面板安装并配置
- Python 3.7+ 已安装
- 项目目录：`/www/wwwroot/etermaiweb/`

## 第一部分：数据库准备

### 1. 在宝塔面板中配置PostgreSQL

1. **启动PostgreSQL服务**
   - 登录宝塔面板
   - 进入"软件商店" → "已安装"
   - 找到PostgreSQL，点击"设置"
   - 确保服务状态为"运行中"

2. **创建数据库**
   - 在PostgreSQL设置页面，点击"数据库"
   - 点击"添加数据库"
   - 数据库名：`etermaiweb`
   - 用户名：`postgres` (使用超级用户)
   - 密码：`Postgre,.1`

3. **配置数据库连接**
   - 确保PostgreSQL监听在 `localhost:5432`
   - 允许本地连接

## 第二部分：SSH密钥配置

### 1. 生成SSH密钥对（在本地电脑上执行）

```powershell
# 生成新的SSH密钥对
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
# 按提示操作，密钥将保存在 ~/.ssh/id_rsa（私钥）和 ~/.ssh/id_rsa.pub（公钥）
```

### 2. 配置云服务器SSH访问

```bash
# 在云服务器上执行
# 创建.ssh目录（如果不存在）
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# 将本地公钥内容添加到authorized_keys
echo "你的公钥内容" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

### 3. 测试SSH连接

```powershell
# 在本地测试SSH连接
ssh root@47.111.119.238
```

## 第三部分：GitHub仓库配置

### 1. 添加服务器信息到GitHub Secrets

在GitHub仓库中，进入 `Settings` → `Secrets and variables` → `Actions`，添加以下Secrets：

| Secret名称 | 值 | 说明 |
|------------|----|----|
| `HOST` | `47.111.119.238` | 云服务器IP地址 |
| `USERNAME` | `root` | SSH登录用户名 |
| `SSH_PRIVATE_KEY` | `私钥内容` | SSH私钥（整个文件内容） |
| `PORT` | `22` | SSH端口号 |

**获取私钥内容：**
```powershell
# Windows上查看私钥内容
Get-Content ~/.ssh/id_rsa
```

复制完整输出，包括 `-----BEGIN OPENSSH PRIVATE KEY-----` 和 `-----END OPENSSH PRIVATE KEY-----`

## 第四部分：手工初始部署

### 1. 在云服务器上执行初始部署

```bash
# SSH连接到云服务器
ssh root@47.111.119.238

# 克隆项目（如果还没有）
cd /www/wwwroot/
git clone https://github.com/LouisLee1983/EtermAIWeb.git etermaiweb
cd etermaiweb

# 执行手工部署脚本
sudo bash deploy/manual-deploy.sh
```

### 2. 部署脚本会自动完成以下步骤：

1. ✅ 环境检查（Python、PostgreSQL）
2. 📥 克隆/更新代码
3. 🐍 创建Python虚拟环境
4. 📦 安装依赖包
5. 📁 创建必要目录
6. 🔐 设置文件权限
7. 🔗 测试数据库连接
8. 📜 创建启动脚本
9. ⚙️ 配置Gunicorn
10. 🛠️ 创建systemd服务
11. 🚀 启动服务
12. 🏥 健康检查

### 3. 预期输出

```bash
=== EtermAIWeb 手工部署脚本 (宝塔面板版本) ===
✅ 使用系统Python: python3
✅ 环境检查通过
更新项目代码...
安装Python依赖...
创建必要目录...
设置文件权限...
检查数据库连接...
✅ 数据库连接成功
创建启动脚本...
创建Gunicorn配置...
创建systemd服务...
启动EtermAIWeb服务...
等待服务启动...
✅ EtermAIWeb服务启动成功
执行健康检查...
✅ 应用健康检查通过

🎉 手工部署完成！
============================================
访问地址: http://47.111.119.238:5000
健康检查: http://47.111.119.238:5000/api/health
============================================
```

## 第五部分：宝塔面板Python项目配置

### 1. 在宝塔面板中创建Python项目

1. **创建站点**
   - 登录宝塔面板
   - 点击"网站" → "Python项目"
   - 点击"添加Python项目"

2. **项目配置**
   - 项目名称：`EtermAIWeb`
   - 项目路径：`/www/wwwroot/etermaiweb`
   - 启动文件：`start.py`
   - 模块名称：`app:app`
   - 端口：`5000`
   - Python版本：选择合适的版本

3. **启动项目**
   - 点击"提交"创建项目
   - 在项目列表中点击"启动"

### 2. 两种运行方式选择

您可以选择以下任一种方式运行应用：

**方式一：systemd服务（推荐）**
- 更稳定，自动重启
- 使用命令：`systemctl status etermaiweb`

**方式二：宝塔面板Python项目**
- 图形化管理
- 在宝塔面板中直接启停

> **注意：** 两种方式不要同时使用，会导致端口冲突！

## 第六部分：GitHub Actions自动化部署

### 1. 工作流程说明

当您将代码推送到main分支时，GitHub Actions会自动：

1. 🔍 检出最新代码
2. 🐍 设置Python环境
3. 💾 缓存依赖
4. 📦 安装依赖
5. 🧪 运行测试（可选）
6. 🚀 SSH连接到服务器
7. 📥 执行代码更新脚本
8. 🔄 重启服务
9. ✅ 完成部署

### 2. 触发条件

- 推送代码到main分支：`git push origin main`
- 合并Pull Request到main分支

### 3. 自动更新流程

代码更新脚本会智能判断：

- 📝 **仅代码更改**：快速重启服务（5-10秒）
- 📦 **依赖更改**：重新安装依赖包，然后重启服务（30-60秒）

## 第七部分：日常管理命令

### 1. 服务管理

```bash
# 查看服务状态
systemctl status etermaiweb

# 启动服务
systemctl start etermaiweb

# 停止服务
systemctl stop etermaiweb

# 重启服务
systemctl restart etermaiweb

# 开机自启
systemctl enable etermaiweb
```

### 2. 日志查看

```bash
# 查看系统日志
journalctl -u etermaiweb -f

# 查看应用日志
tail -f /www/wwwroot/etermaiweb/logs/gunicorn_error.log
tail -f /www/wwwroot/etermaiweb/logs/gunicorn_access.log
```

### 3. 手动代码更新

```bash
# 如果GitHub Actions失败，可以手动更新
cd /www/wwwroot/etermaiweb
sudo bash deploy/update-code.sh
```

## 第八部分：故障排除

### 1. 常见问题

**问题1：服务启动失败**
```bash
# 查看详细错误信息
journalctl -u etermaiweb --no-pager
tail -f /www/wwwroot/etermaiweb/logs/gunicorn_error.log
```

**问题2：数据库连接失败**
```bash
# 检查PostgreSQL状态
systemctl status postgresql
# 或在宝塔面板中检查PostgreSQL服务状态
```

**问题3：端口被占用**
```bash
# 查看端口占用
netstat -tlnp | grep 5000
# 杀死占用进程
kill -9 进程ID
```

**问题4：权限问题**
```bash
# 重新设置权限
chown -R www:www /www/wwwroot/etermaiweb
```

### 2. GitHub Actions失败处理

1. **查看Actions日志**
   - 进入GitHub仓库
   - 点击"Actions"标签
   - 查看失败的工作流详情

2. **常见失败原因**
   - SSH连接失败：检查Secrets配置
   - 权限不足：确保SSH用户有sudo权限
   - 服务重启失败：检查服务状态

## 第九部分：测试验证

### 1. 健康检查

```bash
# 本地测试
curl http://localhost:5000/api/health

# 远程测试
curl http://47.111.119.238:5000/api/health
```

### 2. 功能测试

1. **访问应用**
   - 浏览器打开：`http://47.111.119.238:5000`
   - 确认页面正常加载

2. **测试API**
   - 测试登录、注册等核心功能
   - 验证数据库交互

### 3. 自动部署测试

1. **修改代码并推送**
```bash
# 修改一个文件
echo "# Test change" >> README.md

# 提交并推送
git add .
git commit -m "测试自动部署"
git push origin main
```

2. **观察部署过程**
   - 在GitHub Actions中查看部署进度
   - 等待部署完成
   - 验证更改已生效

## 第十部分：性能优化建议

### 1. Gunicorn优化

根据服务器配置调整worker数量：
```bash
# 编辑配置文件
vim /www/wwwroot/etermaiweb/gunicorn.conf.py

# 推荐worker数量 = CPU核心数 * 2 + 1
workers = 5  # 假设是双核服务器
```

### 2. 数据库优化

在宝塔面板中优化PostgreSQL配置：
- 调整shared_buffers
- 优化work_mem
- 配置适当的连接池

### 3. 监控和告警

可以配置：
- 宝塔面板监控告警
- 自定义健康检查脚本
- 日志轮转策略

---

## 总结

通过以上步骤，您已经完成了：

1. ✅ **初始部署**：项目成功部署到云服务器
2. ✅ **自动化CI/CD**：GitHub代码更新自动部署
3. ✅ **服务管理**：systemd服务自动启停和监控
4. ✅ **宝塔面板集成**：可选的图形化管理方式
5. ✅ **故障排除**：完整的问题诊断和解决方案

现在您可以专注于业务开发，每次代码推送都会自动部署到生产环境！

**重要提醒：**
- 第一次部署请使用手工部署脚本
- 确保SSH密钥正确配置
- 选择一种服务运行方式（systemd或宝塔面板）
- 定期备份数据库和代码 