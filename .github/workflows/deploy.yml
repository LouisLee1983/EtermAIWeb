name: è‡ªåŠ¨éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è¿è¡Œæµ‹è¯• (å¯é€‰)
      run: |
        # å¦‚æœæœ‰æµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥è¿è¡Œæµ‹è¯•
        # python -m pytest tests/
        echo "æµ‹è¯•æ­¥éª¤ - æš‚æ—¶è·³è¿‡"
        
    - name: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "å¼€å§‹éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨..."
          
          # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
          cd /www/wwwroot/etermaiweb || { echo "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }
          
          # åœæ­¢æœåŠ¡ (å¦‚æœæ­£åœ¨è¿è¡Œ)
          sudo systemctl stop etermaiweb || echo "æœåŠ¡æœªè¿è¡Œ"
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          sudo cp -r /www/wwwroot/etermaiweb /www/wwwroot/etermaiweb_backup_$(date +%Y%m%d_%H%M%S) || echo "å¤‡ä»½å¤±è´¥"
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          sudo git fetch origin
          sudo git reset --hard origin/main
          
          # å®‰è£…/æ›´æ–°Pythonä¾èµ–
          sudo python3 -m pip install -r requirements.txt
          
          # è¿è¡Œæ•°æ®åº“è¿ç§» (å¦‚æœéœ€è¦)
          # sudo python3 manage.py db upgrade
          
          # é‡æ–°å¯åŠ¨æœåŠ¡
          sudo systemctl start etermaiweb
          sudo systemctl enable etermaiweb
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          sleep 5
          if sudo systemctl is-active --quiet etermaiweb; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡æ­£åœ¨è¿è¡Œ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æœåŠ¡æœªèƒ½æ­£å¸¸å¯åŠ¨"
            sudo systemctl status etermaiweb
            exit 1
          fi
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          
    - name: å‘é€éƒ¨ç½²é€šçŸ¥ (å¯é€‰)
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥" 
          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
        fi 