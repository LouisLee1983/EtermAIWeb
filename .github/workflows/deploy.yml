name: è‡ªåŠ¨éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è¿è¡Œæµ‹è¯• (å¯é€‰)
      run: |
        # å¦‚æœæœ‰æµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥è¿è¡Œæµ‹è¯•
        # python -m pytest tests/
        echo "æµ‹è¯•æ­¥éª¤ - æš‚æ—¶è·³è¿‡"
        
    - name: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "å¼€å§‹Dockeréƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨..."
          
          # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
          cd /www/wwwroot/etermaiweb || { echo "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git fetch origin
          git reset --hard origin/main
          
          # æ™ºèƒ½éƒ¨ç½²ç­–ç•¥ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ„å»º
          NEED_REBUILD=false
          
          # æ£€æŸ¥å…³é”®Dockeræ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff HEAD~1 HEAD --name-only | grep -E "(Dockerfile|requirements\.txt|docker-compose\.yml)" > /dev/null; then
            echo "ğŸ”¨ æ£€æµ‹åˆ°Dockeré…ç½®æ–‡ä»¶å˜åŒ–ï¼Œéœ€è¦é‡æ–°æ„å»º"
            NEED_REBUILD=true
          fi
          
          # æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
          if ! docker-compose ps | grep -q "Up"; then
            echo "ğŸ”¨ æ£€æµ‹åˆ°å®¹å™¨æœªè¿è¡Œï¼Œéœ€è¦å¯åŠ¨"
            NEED_REBUILD=true
          fi
          
          if [ "$NEED_REBUILD" = true ]; then
            echo "ğŸ”¨ æ‰§è¡Œå®Œæ•´æ„å»ºéƒ¨ç½²..."
            
            # åœæ­¢ç°æœ‰å®¹å™¨
            docker-compose down || echo "æ²¡æœ‰è¿è¡Œçš„å®¹å™¨"
            
            # å¤‡ä»½Redisæ•°æ®
            echo "å¤‡ä»½Redisæ•°æ®..."
            mkdir -p backup
            docker run --rm -v etermaiweb_redis_data:/data -v $(pwd)/backup:/backup alpine tar czf /backup/redis_backup_$(date +%Y%m%d_%H%M%S).tar.gz -C /data . || echo "Rediså¤‡ä»½å¤±è´¥"
            
            # æ¸…ç†Dockerç¼“å­˜
            docker system prune -f || echo "æ¸…ç†å¤±è´¥"
            
            # æ„å»ºå¹¶å¯åŠ¨
            docker-compose up -d --build
            
          else
            echo "âš¡ æ‰§è¡Œå¿«é€Ÿä»£ç æ›´æ–°..."
            
            # ä¼˜åŒ–ç­–ç•¥ï¼šåªé‡æ–°æ„å»ºåº”ç”¨å®¹å™¨ï¼Œå¤ç”¨Redis
            echo "åœæ­¢åº”ç”¨å®¹å™¨ï¼ˆä¿æŒRedisè¿è¡Œï¼‰..."
            docker-compose stop app
            
            # ä½¿ç”¨ç¼“å­˜å¿«é€Ÿé‡æ–°æ„å»ºåº”ç”¨å®¹å™¨
            echo "å¿«é€Ÿé‡æ–°æ„å»ºåº”ç”¨å®¹å™¨ï¼ˆåˆ©ç”¨Dockerç¼“å­˜ï¼‰..."
            docker-compose build app
            
            # å¯åŠ¨åº”ç”¨å®¹å™¨
            echo "å¯åŠ¨æ›´æ–°åçš„åº”ç”¨å®¹å™¨..."
            docker-compose up -d app
            
            # å¦‚æœå¤±è´¥ï¼Œå°è¯•å®Œæ•´é‡å¯
            if [ $? -ne 0 ]; then
              echo "å¿«é€Ÿæ›´æ–°å¤±è´¥ï¼Œæ‰§è¡Œå®Œæ•´é‡å¯..."
              docker-compose down
              docker-compose up -d --build
            fi
          fi
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ"
          else
            echo "âŒ Dockerå®¹å™¨å¯åŠ¨å¤±è´¥"
            docker-compose logs
            exit 1
          fi
          
          # å¥åº·æ£€æŸ¥
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if curl -f http://localhost:5000/api/health > /dev/null 2>&1; then
              echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            else
              echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨... (å°è¯• $attempt/$max_attempts)"
              sleep 10
              attempt=$((attempt + 1))
            fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
            docker-compose logs app
            exit 1
          fi
          
          echo "ğŸ‰ Dockeréƒ¨ç½²å®Œæˆï¼"
          echo "å®¹å™¨çŠ¶æ€:"
          docker-compose ps
          
    - name: å‘é€éƒ¨ç½²é€šçŸ¥ (å¯é€‰)
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥" 
          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
        fi 